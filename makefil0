##########################
# Makefile for MK2       #
##########################

# Commands commented in LEGACY: <command> are used before tools were updated: 26/01/24

#build:
#	:: ## LEGACY: masm386 W:\base\boot\boot.asm W:\base\boot\boot.obj NUL NUL
#	:: ## LEGACY: masm386 W:\base\boot\mk2ldr.asm W:\base\boot\mk2ldr.obj NUL NUL
#	:: ## LEGACY: link16 /TINY /NOD W:\base\boot\boot.obj, W:\base\boot\boot.bin, NUL, NUL, NUL
#	:: ## LEGACY: link16 /TINY /NOD W:\base\boot\mk2ldr.obj, W:\base\boot\mk2ldr.sys, NUL, NUL, NUL
#

# Useful notes for nmake:
#   - Commands are executed in command prompt so use REM or :: to comment something out while doing something in a function.
#   - Use '@' to suppress the command being shown. (same syntax in batch script)
#   - nmake variables are converted at runtime.
#

!INCLUDE base\boot\sources
all: buildbootl buildkrnlbootstrap

buildbootl:
	ech BUILD: Building $(MODULEDIR)
	cd W:\$(MODULEDIR)
	ML16 /AT /c /nologo $(SOURCES)
	LINK16 /TINY /NOD boot.obj, bootsect.bin, NUL, NUL, NUL
	cd ..
	ech BUILD: Ended building base\boot

!INCLUDE base\mk2os\sources

buildkrnlbootstrap:
	@ech BUILD: Building $(MODULEDIR)
	@cd W:\$(MODULEDIR)
	@ML16 /AT /c /nologo $(ASMSOURCES)
	@LINK16 /TINY /NOD bootstrap.obj, bootstrap.LDR, NUL, NUL, NUL
	@cd ..
	@ech BUILD: Ended building $(MODULEDIR)

copytofloppy:
	@ech !!! WARNING !!!
	@ech 
	@ech THIS WILL OVERWRITE THE DRIVE in A:
	@ech 
	@ech TYPE CTRL+BREAK to STOP (OR CTRL+C)
	@ech
	@PAUSE
	wdd if=base\boot\bootsect.bin of=\\.\A:
	copy base\mk2os\bootstrap.LDR A:\bootstr.LDR
	@ech THE A DRIVE WAS OVERWRITTEN WITH MK2!
	@ech
	@ech YOU CAN THEN BOOT FROM THE A DRIVE TO BOOT INTO MK2.


diskimgfloppy:
	@ech COPYING DRIVE A: INTO MK2OUT.IMG
	@ech
	wdd if=\\.\A: of=MK2OUT.IMG
	
clean:
	del base\boot\*.bin
	del base\boot\*.obj
	del base\mk2os\*.obj
	del base\mk2os\*.LDR
	